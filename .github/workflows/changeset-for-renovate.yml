name: Write Renovate changeset
on:
  pull_request_target:
    paths:
      - '.github/workflows/changeset-for-renovate.yml'
      - '**/yarn.lock'


jobs:
  generate-changeset:
    runs-on: ['self-hosted', 'org', '8-cpu']
    if: github.actor == 'renovate[bot]'
    steps:
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: 'enable corepack for yarn'
        run: sudo corepack enable yarn
      - uses: actions/checkout@v4
      # must call twice because of chicken and egg problem with yarn and node
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'yarn'
      - name: Restore node cache
        uses: actions/cache@v3
        id: cache_node
        with:
          # We need to cache all the artifacts generated by yarn install+build
          # Update this list also in .github/actions/sync-workspace/action.yml with exactly the same list
          path: |
            ./.yarn/cache
            ./.yarn/install-state.gz
            node_modules
            packages/**/node_modules
          key: node-${{ runner.os }}-${{ runner.arch }}-${{ env.NODE_MODULE_CACHE_VERSION }}-${{ hashFiles('yarn.lock') }}
          restore-keys: |
            node-${{ runner.os }}-${{ runner.arch }}-${{ env.NODE_MODULE_CACHE_VERSION }}-
      - name: Install yarn dependencies
        # skip check due to YN0078: │ Invalid resolution @celo/connect@npm:^5.1.1 → npm:5.1.1
        run: git config --global url."https://".insteadOf ssh:// && yarn install  --no-check-resolutions
      - name: "Run changesets-renovate"
        # when on a renovate branch which modified the package.json for a workspace this will  create a changeset for those changes
        run: yarn changesets-renovate

