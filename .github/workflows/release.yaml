name: Release Packages

on:
  workflow_dispatch:
  push:
    branches:
      - master
      - hotfixes
      - feat/release-13

concurrency: ${{ github.workflow }}-${{ github.ref }}

jobs:
  release:
    name: Open Release PR or Publish Packages
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
      pull-requests: write
      security-events: write
      attestations: write
      id-token: write
      repository-projects: write
    env:
      NODE_VERSION: 20
      VERSION_COMMAND: yarn version-then-update-files
      PUBLISH_COMMAND: yarn release --dry-run --provenance
      OIDC_DUMP: true

    steps:
      # Security policy docker is configured in step security app
      # Policy can be seen here https://app.stepsecurity.io/github/celo-org/actions/policies/docker
      # disable-sudo is set to false if debug is true, because tmate requires root to work.
      - name: Harden Runner
        uses: step-security/harden-runner@v2
        if: runner.environment == 'github-hosted'
        with:
          egress-policy: audit

      - name: Dump OIDC claims (no secrets)
        if: ${{ env.OIDC_DUMP == 'true' }}
        run: |
          echo "Requesting OIDC token..."
          TOKEN_JSON=$(curl -s \
           -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
           "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=npm")

          echo "$TOKEN_JSON" | jq -r '.value' > oidc.jwt

          echo "OIDC JWT claims:"
          jq -R 'split(".") | .[1] | @base64d | fromjson' oidc.jwt

      - name: "Checkout"
        uses: actions/checkout@v4

      - name: Check if GHAS is Enabled
        uses: actions/github-script@v7
        id: ghas-check
        with:
          script: |
            const [owner, repo] = '${{ github.repository }}'.split("/");
            const res = await github.rest.repos.get({ owner, repo });
            const isPrivate = res.data.private;
            const hasGhas = res.data.security_and_analysis?.advanced_security?.status === 'enabled';
            if (isPrivate && !hasGhas) {
              core.warning('GHAS is NOT enabled and repo is private. Cannot upload SARIF.');
              return false;
            }
            return true;

      - name: Run Trivy Scan
        id: trivy-fs
        uses: celo-org/trivy-composite-action@v1.0.1
        with:
          scan-type: fs
          scan-ref: "."
          timeout: 15m
          vuln-type: "os,library"
          severity: "UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL"

      - name: Upload SARIF to Security Tab
        if: fromJSON(steps.ghas-check.outputs.result)
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ${{ steps.trivy-fs.outputs.sarif-file }}
          category: fs-${{ steps.split.outputs.app_name }}

      - name: Delete trivy files
        shell: bash
        run: |
          repo_name=$(basename "$GITHUB_REPOSITORY")
          rm -rf "${repo_name}"-*.json
          rm -rf "${repo_name}"-*.sarif
          rm -rf "${repo_name}"-*.txt
          rm -rf .cache/

      # Setup Node JS with input from node version and set the registry url for github packages
      # DON'T USE registry-url due to https://github.com/changesets/action/issues/132
      - name: "Setup Node JS"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: "enable corepack for yarn"
        run: sudo corepack enable yarn
        shell: bash

      # must call twice because of chicken and egg problem with yarn and node
      # DON'T USE registry-url due to https://github.com/changesets/action/issues/132
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "yarn"

      - name: Install Dependencies
        shell: bash
        run: yarn

      - name: Create Release Pull Request or Publish to npm
        id: changesets
        uses: changesets/action@v1
        with:
          # This expects you to have a script called release which does a build for your packages and calls changeset publish
          publish: ${{ env.PUBLISH_COMMAND }}
          version: ${{ env.VERSION_COMMAND }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_PROVENANCE: "1" 


  # release gives an array of published packages as json objects, we need an array of strings for installing
  prepare:
    name: Format Output for Install
    if: needs.release.outputs.published == 'true'
    needs: release
    runs-on: ['self-hosted', 'org', 'ubuntu-22-04']
    container:
      image: node:20-bullseye
    outputs:
      result: '${{ steps.map.outputs.output }}'
    steps:
      - name: Install jq
        uses: dcarbone/install-jq-action@v3.0.1
      - name: Format Published Packages Array
        uses: cloudposse/github-action-jq@main
        id: map
        with:
          compact: true
          raw-output: true
          input: '${{ needs.release.outputs.publishedPackages }}'
          script: |-
            map("\(.name)@\(.version)")

  # last line of defense to ensure that the packages were published correctly
  install-released-packages:
    name: Install Released Packages
    needs: [prepare, release]
    outputs:
      assetStableCLIRelease: ${{ steps.assertStableVersion.outcome }}
    if: needs.release.outputs.published == 'true' && needs.prepare.outputs.result
    runs-on: ['self-hosted', 'org', 'ubuntu-22-04']
    container:
      image: node:20-bullseye
    strategy:
      fail-fast: false
      max-parallel: 12
      matrix:
        package: ${{fromJson(needs.prepare.outputs.result)}}
    steps:
      - name: Install @celo/celocli dependencies
        if: contains(matrix.package, '@celo/celocli')
        run: |
          apt update
          apt install -y libusb-1.0-0-dev libudev-dev
          npm install node-gyp --global

      - name: Installing ${{ matrix.package }} package
        run: npm install ${{ matrix.package }} --global
      - name: Ensure sample of celocli commands run
        if: contains(matrix.package, '@celo/celocli')
        run: |
          celocli --version
          celocli account:new
          echo "checking celo community fund balance"
          celocli account:balance 0xD533Ca259b330c7A88f74E000a3FaEa2d63B7972 --node celo
          celocli network:whitelist --rpc testnet

      - name: Checkout Repo
        if: contains(matrix.package, '@celo/celocli')
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            scripts
      - name: Is stable celocli release
        id: assertStableVersion
        if: contains(matrix.package, '@celo/celocli')
        continue-on-error: true
        run: |
          version=$(echo "${{ matrix.package }}" | cut -d "@" -f3)
          ./scripts/assert_stable_version "$version"

  open-docs-pr:
    needs: [install-released-packages]
    if: ${{ needs.install-released-packages.outputs.assetStableCLIRelease != 'failure' }}
    uses: celo-org/developer-tooling/.github/workflows/open-docs-pr.yml@master
    with:
      commit: ${{ github.sha }}

  upload-executables:
    needs: [install-released-packages]
    if: ${{ needs.install-released-packages.outputs.assetStableCLIRelease != 'failure' }}
    uses: celo-org/developer-tooling/.github/workflows/upload-celocli-executables.yml@master
    with:
      ref: ${{ github.sha }}
