---
name: Open a pull-request on the celo-org/docs repository

on:
  workflow_call:
    inputs:
      commit:
        description: 'Commit of the developer-tooling repo that the submodule will be updated to'
        type: string
        required: true

  workflow_dispatch:
    inputs:
      commit:
        description: 'Commit of the developer-tooling repo that the submodule will be updated to'
        type: string
        required: true

jobs:
  open-docs-pr:
    name: Open a pull-request on the celo-org/docs repository
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
      pull-requests: write
      repository-projects: write
    steps:
      - name: Fetch secrets from AKeyless
        id: fetch-secrets
        uses: docker://us-west1-docker.pkg.dev/devopsre/akeyless-public/akeyless-action:latest
        with:
          access-id: p-kf9vjzruht6l
          api-url: https://api.gateway.akeyless.celo-networks-dev.org
          dynamic-secrets: '{"/dynamic-secrets/keys/github/docs/contents=write,pull_requests=write":"DOCS_TOKEN"}'

      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          repository: 'celo-org/docs'
          submodules: 'recursive'
          fetch-depth: 0
          ref: main
          token: ${{ env.DOCS_TOKEN }}

      - name: Open pull-request
        env:
          COMMIT: ${{ inputs.commit }}
          REPOSITORY: 'celo-org/docs'
          DOCS_CWD: 'celo-docs'
          BASE_BRANCH: main
          NEW_BRANCH: 'ci/${{ github.run_id }}-${{ github.run_attempt }}'
          BOT_NAME: 'github-actions'
          BOT_EMAIL: 'github-actions@github.com'

        run: |
          set -x

          # Setup the committers identity.
          git config --global user.name $BOT_NAME
          git config --global user.email $BOT_EMAIL

          # Create a new feature branch for the changes.
          git checkout -b $NEW_BRANCH

          # Initialize submodule if it doesn't exist
          if [ ! -d "submodules/developer-tooling" ]; then
            git submodule add https://github.com/celo-org/developer-tooling.git submodules/developer-tooling
            git submodule update --init --recursive
          fi

          cd submodules/developer-tooling
          git fetch --all
          git checkout $COMMIT
          cd ../..
          
          # Create target directory if it doesn't exist
          mkdir -p ./tooling/libraries-sdks/cli
          
          # Remove existing files except index.md and readme files
          find ./tooling/libraries-sdks/cli -type f \( -name "*.md" -o -name "*.mdx" \) ! -name "index.mdx" ! -name "*readme*" ! -name "*README*" -delete
          
          # Copy files and rename .md to .mdx
          for file in ./submodules/developer-tooling/docs/command-line-interface/*.md; do
            if [ -f "$file" ]; then
              basename=$(basename "$file" .md)
              cp "$file" "./tooling/libraries-sdks/cli/${basename}.mdx"
            fi
          done
          
          # Add frontmatter to each command doc file
          for file in ./tooling/libraries-sdks/cli/*.mdx; do
            if [ -f "$file" ]; then
              basename=$(basename "$file" .mdx)
              # Skip index file and readme files
              if [[ "$basename" != "index" && "$basename" != *"readme"* && "$basename" != *"README"* ]]; then
                # Capitalize first letter of command name
                capitalized=$(echo "$basename" | sed 's/^./\U&/')
                
                # Create temporary file with frontmatter
                echo "---" > "$file.tmp"
                echo "title: celocli $basename" >> "$file.tmp"
                echo "sidebarTitle: \"$capitalized\"" >> "$file.tmp"
                echo "---" >> "$file.tmp"
                echo "" >> "$file.tmp"
                # Append original content
                cat "$file" >> "$file.tmp"
                # Replace original file
                mv "$file.tmp" "$file"
              fi
            fi
          done
          
          # Fix USAGE code blocks to have sh syntax highlighting
          for file in ./tooling/libraries-sdks/cli/*.mdx; do
            if [ -f "$file" ]; then
              # Replace ``` followed by newline and USAGE with ```sh followed by newline and USAGE
              sed -i '/^```$/{N;s/^```\nUSAGE/```sh\nUSAGE/;}' "$file"
            fi
          done
          
          # Update docs.json to only include CLI pages that exist
          echo "Current directory: $(pwd)"
          echo "Looking for docs.json..."
          ls -la docs.json || echo "docs.json not found"
          
          if [ -f "docs.json" ]; then
            echo "Found docs.json, updating CLI pages..."
            
            # Create list of existing CLI files (without .mdx extension)
            echo "Scanning CLI files in ./tooling/libraries-sdks/cli/"
            ls -la ./tooling/libraries-sdks/cli/
            
            # Start with index if it exists
            cli_files=""
            if [ -f "./tooling/libraries-sdks/cli/index.mdx" ]; then
              cli_files="\"tooling/libraries-sdks/cli/index\""
              echo "Found CLI file: index (added first)"
            fi
            
            # Add all other files (excluding index since we already added it)
            for file in ./tooling/libraries-sdks/cli/*.mdx; do
              if [ -f "$file" ]; then
                basename=$(basename "$file" .mdx)
                if [ "$basename" != "index" ]; then
                  echo "Found CLI file: $basename"
                  if [ -n "$cli_files" ]; then
                    cli_files="$cli_files,"
                  fi
                  cli_files="$cli_files\"tooling/libraries-sdks/cli/$basename\""
                fi
              fi
            done
            
            echo "CLI files list: [$cli_files]"
            
            # Use jq to update the CLI pages section in docs.json
            echo "Updating docs.json with jq..."
            jq --argjson pages "[$cli_files]" '
              (.navigation.tabs[] | select(.tab == "Tooling") | .groups[] | select(.group == "Libraries & SDKs") | .pages[2] | .pages) = $pages
            ' docs.json > docs.json.tmp && mv docs.json.tmp docs.json
            
            echo "docs.json updated successfully"
          else
            echo "docs.json not found in current directory"
          fi
          
          # Add warning file about generated content (only if it doesn't exist)
          if [ ! -f "./tooling/libraries-sdks/cli/README.txt" ]; then
            cat > ./tooling/libraries-sdks/cli/README.txt << 'EOF'
          âš ï¸ Do Not Edit These Files Directly

          The files in this directory (except for index.mdx) are automatically generated from the celo-org/developer-tooling repository.

          To make changes to the CLI documentation:
          1. Edit the source files in the developer-tooling repository
          2. The changes will be automatically synced to this documentation site

          Any manual edits made directly to these files will be overwritten during the next sync.
          EOF
          fi

          git status
          git add submodules/developer-tooling
          git add tooling/libraries-sdks/cli
          git add docs.json
          git commit -m "chore: update developer-tooling submodule"
          git push origin $NEW_BRANCH

          cat >/tmp/pr-body.md <<EOL
          Update developer-tooling submodule to [$COMMIT](https://github.com/celo-org/developer-tooling/commit/$COMMIT).

          Merging this pull-request will update the docs using generated files (such as the CLI docs).

          ðŸ¤– _This pull-request was opened by a robot beep boop._ ðŸ¤–
          EOL

          echo "$DOCS_TOKEN" > token.txt
          gh auth login --with-token < token.txt
          gh pr create \
            --body-file /tmp/pr-body.md \
            --title "chore: update auto-generated docs reference from developer-tooling" \
            --head "$NEW_BRANCH" \
            --base "$BASE_BRANCH"
